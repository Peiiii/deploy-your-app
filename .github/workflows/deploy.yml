name: Deploy to Aliyun Server

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -t deploy-your-app-server:latest .

      - name: Save Docker image
        run: |
          docker save deploy-your-app-server:latest | gzip > deploy-image.tar.gz

      - name: Upload deployment files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ALIYUN_HOST }}
          username: ${{ secrets.ALIYUN_USER }}
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          port: ${{ secrets.ALIYUN_PORT || 22 }}
          source: "deploy-image.tar.gz,scripts/deploy.sh"
          target: "/tmp/deploy-your-app"
          strip_components: 0

      - name: Execute deployment script
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ALIYUN_HOST }}
          username: ${{ secrets.ALIYUN_USER }}
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          port: ${{ secrets.ALIYUN_PORT || 22 }}
          script: |
            set -e
            echo "üîç Pre-deployment checks..."
            echo "Docker version: $(docker --version)"
            echo "Available disk space:"
            df -h / | tail -1
            echo ""
            echo "Checking deployment files..."
            ls -lh /tmp/deploy-your-app/ || echo "Directory does not exist yet"
            echo ""
            mkdir -p /tmp/deploy-your-app
            chmod +x /tmp/deploy-your-app/scripts/deploy.sh
            echo "Executing deployment script..."
            /tmp/deploy-your-app/scripts/deploy.sh /tmp/deploy-your-app/deploy-image.tar.gz
            echo ""
            echo "‚úÖ Deployment script completed"
            # Cleanup
            rm -f /tmp/deploy-your-app/deploy-image.tar.gz

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ALIYUN_HOST }}
          username: ${{ secrets.ALIYUN_USER }}
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          port: ${{ secrets.ALIYUN_PORT || 22 }}
          script: |
            echo "üîç Verifying deployment..."
            sleep 5
            
            CONTAINER_NAME="deploy-your-app"
            PORT=${PORT:-4173}
            
            # Check if container exists (running or stopped)
            if docker ps -a --filter "name=${CONTAINER_NAME}" --format "{{.Names}}" | grep -q "${CONTAINER_NAME}"; then
              echo "üìã Container exists"
              # Check if container is running
              if docker ps --filter "name=${CONTAINER_NAME}" --format "{{.Names}}" | grep -q "${CONTAINER_NAME}"; then
                echo "‚úÖ Container is running"
                docker ps --filter "name=${CONTAINER_NAME}" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            else
              echo "‚ùå Container exists but is not running"
              echo "üìã Container status:"
              docker ps -a --filter "name=${CONTAINER_NAME}" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
              echo ""
              echo "üìù Container exit code:"
              docker inspect "${CONTAINER_NAME}" --format='{{.State.ExitCode}}' 2>/dev/null || echo "Unknown"
              echo ""
              echo "üìù Container logs (last 50 lines):"
              docker logs --tail 50 "${CONTAINER_NAME}" 2>&1 || echo "Failed to get logs"
              echo ""
              echo "üîç Container state details:"
              docker inspect "${CONTAINER_NAME}" --format='State: {{.State.Status}}, ExitCode: {{.State.ExitCode}}, Error: {{.State.Error}}' 2>/dev/null || echo "Failed to inspect"
              exit 1
            fi
            else
              echo "‚ùå Container does not exist"
              echo "üìã All containers:"
              docker ps -a
              echo ""
              echo "üìã Available images:"
              docker images | grep deploy-your-app || echo "No deploy-your-app images found"
              exit 1
            fi
            
            # Test API endpoint
            echo ""
            echo "üß™ Testing API endpoint..."
            if curl -f -s http://localhost:${PORT}/api/v1/projects > /dev/null 2>&1; then
              echo "‚úÖ API is responding (HTTP 200)"
              echo "üåê Service URL: http://${{ secrets.ALIYUN_HOST }}:${PORT}"
              echo "üìä API endpoint: http://${{ secrets.ALIYUN_HOST }}:${PORT}/api/v1/projects"
            else
              echo "‚ùå API is not responding"
              echo "üìù Container logs:"
              docker logs --tail 30 "${CONTAINER_NAME}" 2>&1 || echo "Failed to get logs"
              echo ""
              echo "üîç Checking port binding:"
              netstat -tulpn | grep ${PORT} || ss -tulpn | grep ${PORT} || echo "Port ${PORT} not found"
              exit 1
            fi

