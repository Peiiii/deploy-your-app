name: Deploy to Aliyun Server

on:
  push:
    branches:
      - main
      - master
    paths:
      - Dockerfile
      - server/**
      - scripts/deploy.sh
      - .github/workflows/deploy.yml
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -t deploy-your-app-server:latest .

      - name: Save Docker image
        run: |
          docker save deploy-your-app-server:latest | gzip > deploy-image.tar.gz

      - name: Upload deployment files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ALIYUN_HOST }}
          username: ${{ secrets.ALIYUN_USER }}
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          port: ${{ secrets.ALIYUN_PORT || 22 }}
          source: "deploy-image.tar.gz,scripts/deploy.sh"
          target: "/tmp/deploy-your-app"
          strip_components: 0

      - name: Execute deployment script
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ALIYUN_HOST }}
          username: ${{ secrets.ALIYUN_USER }}
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          port: ${{ secrets.ALIYUN_PORT || 22 }}
          envs: CLOUDFLARE_ACCOUNT_ID,CLOUDFLARE_API_TOKEN,DASHSCOPE_API_KEY,DEPLOY_TARGET,CLOUDFLARE_PAGES_PROJECT_PREFIX,R2_ACCOUNT_ID,R2_ACCESS_KEY_ID,R2_SECRET_ACCESS_KEY,R2_BUCKET_NAME,APPS_ROOT_DOMAIN,CLOUDFLARE_D1_DATABASE_ID,CLOUDFLARE_D1_API_TOKEN,STORAGE_TYPE
          script: |
            set -e
            echo "üîç Pre-deployment checks..."
            echo "Docker version: $(docker --version)"
            echo "Available disk space:"
            df -h / | tail -1
            echo ""
            echo "Checking deployment files..."
            ls -lh /tmp/deploy-your-app/ || echo "Directory does not exist yet"
            echo ""
            mkdir -p /tmp/deploy-your-app
            chmod +x /tmp/deploy-your-app/scripts/deploy.sh
            echo "Executing deployment script..."
            # Sensitive secrets from GitHub Secrets and non-sensitive configs from Variables
            # will be passed to the deployment script and then to Docker container
            /tmp/deploy-your-app/scripts/deploy.sh /tmp/deploy-your-app/deploy-image.tar.gz
            echo ""
            echo "‚úÖ Deployment script completed"
            # Cleanup
            rm -f /tmp/deploy-your-app/deploy-image.tar.gz
        env:
          # Sensitive information - use Secrets
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
          # Cloudflare R2 credentials (S3-compatible)
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          CLOUDFLARE_D1_DATABASE_ID: ${{ secrets.CLOUDFLARE_D1_DATABASE_ID }}
          CLOUDFLARE_D1_API_TOKEN: ${{ secrets.CLOUDFLARE_D1_API_TOKEN }}
          # Non-sensitive configuration - use Variables (fallback handled in code if not set)
          DEPLOY_TARGET: ${{ vars.DEPLOY_TARGET }}
          CLOUDFLARE_PAGES_PROJECT_PREFIX: ${{ vars.CLOUDFLARE_PAGES_PROJECT_PREFIX }}
          APPS_ROOT_DOMAIN: ${{ vars.APPS_ROOT_DOMAIN }}
          STORAGE_TYPE: ${{ vars.STORAGE_TYPE }}

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ALIYUN_HOST }}
          username: ${{ secrets.ALIYUN_USER }}
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          port: ${{ secrets.ALIYUN_PORT || 22 }}
          script: |
            echo "üîç Verifying deployment..."
            sleep 5
            
            CONTAINER_NAME="deploy-your-app"
            PORT=${PORT:-80}
            
            # Check if container exists (running or stopped)
            if docker ps -a --filter "name=${CONTAINER_NAME}" --format "{{.Names}}" | grep -q "${CONTAINER_NAME}"; then
              echo "üìã Container exists"
              # Check if container is running
              if docker ps --filter "name=${CONTAINER_NAME}" --format "{{.Names}}" | grep -q "${CONTAINER_NAME}"; then
                echo "‚úÖ Container is running"
                docker ps --filter "name=${CONTAINER_NAME}" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
              else
                echo "‚ùå Container exists but is not running"
                echo "üìã Container status:"
                docker ps -a --filter "name=${CONTAINER_NAME}" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
                echo ""
                echo "üìù Container exit code:"
                docker inspect "${CONTAINER_NAME}" --format='{{.State.ExitCode}}' 2>/dev/null || echo "Unknown"
                echo ""
                echo "üìù Container logs (last 50 lines):"
                docker logs --tail 50 "${CONTAINER_NAME}" 2>&1 || echo "Failed to get logs"
                echo ""
                echo "üîç Container state details:"
                docker inspect "${CONTAINER_NAME}" --format='State: {{.State.Status}}, ExitCode: {{.State.ExitCode}}, Error: {{.State.Error}}' 2>/dev/null || echo "Failed to inspect"
                exit 1
              fi
            else
              echo "‚ùå Container does not exist"
              echo "üìã All containers:"
              docker ps -a
              echo ""
              echo "üìã Available images:"
              docker images | grep deploy-your-app || echo "No deploy-your-app images found"
              exit 1
            fi

            # Basic HTTP connectivity check (Node backend only exposes deploy APIs;
            # projects CRUD is handled by the Cloudflare Worker now).
            echo ""
            echo "üß™ Checking HTTP connectivity on port ${PORT}..."
            if curl -s --max-time 5 -o /dev/null "http://localhost:${PORT}/"; then
              echo "‚úÖ HTTP endpoint is reachable"
              echo "üåê Service base URL: http://${{ secrets.ALIYUN_HOST }}:${PORT}"
            else
              echo "‚ùå HTTP endpoint is not reachable"
              echo "üìù Container logs:"
              docker logs --tail 30 "${CONTAINER_NAME}" 2>&1 || echo "Failed to get logs"
              echo ""
              echo "üîç Checking port binding:"
              netstat -tulpn | grep ${PORT} || ss -tulpn | grep ${PORT} || echo "Port ${PORT} not found"
              exit 1
            fi
