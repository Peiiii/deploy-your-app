name: Cleanup Remote Storage

on:
  workflow_dispatch:
    inputs:
      cleanup_type:
        description: 'æ¸…ç†ç±»åž‹'
        required: true
        type: choice
        options:
          - builds-only
          - apps-only
          - projects-only
          - all
        default: 'builds-only'
      dry_run:
        description: 'é¢„è§ˆæ¨¡å¼ï¼ˆä¸å®žé™…åˆ é™¤ï¼‰'
        required: false
        type: boolean
        default: true

jobs:
  cleanup:
    name: Cleanup Remote Storage
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Upload cleanup script
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ALIYUN_HOST }}
          username: ${{ secrets.ALIYUN_USER }}
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          port: ${{ secrets.ALIYUN_PORT || 22 }}
          source: "scripts/cleanup-storage.sh"
          target: "/tmp/deploy-your-app"
          strip_components: 0

      - name: Execute cleanup script
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ALIYUN_HOST }}
          username: ${{ secrets.ALIYUN_USER }}
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          port: ${{ secrets.ALIYUN_PORT || 22 }}
          script: |
            set -e
            
            echo "ðŸ§¹ === è¿œç¨‹å­˜å‚¨æ¸…ç†å·¥å…· ==="
            echo "æ¸…ç†ç±»åž‹: ${{ github.event.inputs.cleanup_type }}"
            echo "é¢„è§ˆæ¨¡å¼: ${{ github.event.inputs.dry_run }}"
            echo ""
            
            # è®¾ç½®æ•°æ®ç›®å½•ï¼ˆæœåŠ¡å™¨ä¸Šçš„å®žé™…è·¯å¾„ï¼‰
            DATA_DIR="/opt/deploy-your-app/data"
            
            # ç¡®ä¿æ¸…ç†è„šæœ¬æœ‰æ‰§è¡Œæƒé™
            chmod +x /tmp/deploy-your-app/scripts/cleanup-storage.sh
            
            # æž„å»ºæ¸…ç†å‘½ä»¤
            CLEANUP_CMD="/tmp/deploy-your-app/scripts/cleanup-storage.sh"
            CLEANUP_CMD="$CLEANUP_CMD --${{ github.event.inputs.cleanup_type }}"
            
            if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
              CLEANUP_CMD="$CLEANUP_CMD --dry-run"
            fi
            
            # è®¾ç½®æ•°æ®ç›®å½•çŽ¯å¢ƒå˜é‡
            export DATA_DIR="$DATA_DIR"
            # è®¾ç½®è·³è¿‡ç¡®è®¤ï¼ˆç”¨äºŽ CI/CDï¼‰
            export SKIP_CONFIRM="true"
            
            echo "ðŸ“Š æ¸…ç†å‰å­˜å‚¨ä½¿ç”¨æƒ…å†µ:"
            if [ -d "$DATA_DIR" ]; then
              echo "æ•°æ®ç›®å½•: $DATA_DIR"
              echo "æ€»å¤§å°: $(du -sh $DATA_DIR 2>/dev/null | cut -f1 || echo 'N/A')"
              echo ""
              echo "å­ç›®å½•å¤§å°:"
              du -sh $DATA_DIR/* 2>/dev/null || echo "æ— å­ç›®å½•"
              echo ""
            else
              echo "âš ï¸  æ•°æ®ç›®å½•ä¸å­˜åœ¨: $DATA_DIR"
              exit 1
            fi
            
            echo "ðŸš€ æ‰§è¡Œæ¸…ç†å‘½ä»¤..."
            echo "å‘½ä»¤: $CLEANUP_CMD"
            echo ""
            
            # æ‰§è¡Œæ¸…ç†ï¼ˆä¸è®¾ç½® set -eï¼Œä»¥ä¾¿æ•èŽ·è¾“å‡ºï¼‰
            $CLEANUP_CMD || {
              EXIT_CODE=$?
              echo ""
              echo "âŒ æ¸…ç†è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç : $EXIT_CODE"
              exit $EXIT_CODE
            }
            
            echo ""
            echo "ðŸ“Š æ¸…ç†åŽå­˜å‚¨ä½¿ç”¨æƒ…å†µ:"
            if [ -d "$DATA_DIR" ]; then
              echo "æ•°æ®ç›®å½•: $DATA_DIR"
              echo "æ€»å¤§å°: $(du -sh $DATA_DIR 2>/dev/null | cut -f1 || echo 'N/A')"
              echo ""
              echo "å­ç›®å½•å¤§å°:"
              du -sh $DATA_DIR/* 2>/dev/null || echo "æ— å­ç›®å½•"
            fi
            
            echo ""
            echo "âœ… æ¸…ç†æ“ä½œå®Œæˆ"

      - name: Show cleanup summary
        if: always()
        run: |
          echo "## ðŸ§¹ å­˜å‚¨æ¸…ç†å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **æ¸…ç†ç±»åž‹**: ${{ github.event.inputs.cleanup_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **é¢„è§ˆæ¨¡å¼**: ${{ github.event.inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰§è¡Œæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—äº†è§£è¯¦ç»†ä¿¡æ¯ã€‚" >> $GITHUB_STEP_SUMMARY

