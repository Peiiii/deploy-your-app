<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDK Test App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background: #f8fafc;
        }

        h1 {
            font-size: 1.25rem;
            color: #1e293b;
            margin-bottom: 16px;
        }

        .btn-group {
            margin-bottom: 8px;
        }

        .btn {
            padding: 10px 16px;
            margin: 4px;
            border: none;
            background: #8b5cf6;
            color: white;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .btn:hover {
            background: #7c3aed;
        }

        .result {
            margin-top: 16px;
            padding: 16px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            white-space: pre-wrap;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .status {
            color: #64748b;
            font-size: 0.85rem;
            margin-bottom: 12px;
        }

        .connected {
            color: #10b981;
        }

        .error {
            color: #ef4444;
        }

        .screenshot {
            max-width: 100%;
            margin-top: 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
    </style>
</head>

<body>
    <h1>ðŸ§ª GemiGo SDK Test</h1>
    <div class="status" id="status">SDK Ready (Auto-connecting...)</div>

    <div class="btn-group">
        <button class="btn" onclick="testGetPageInfo()">Page Info</button>
        <button class="btn" onclick="testGetPageHTML()">Page HTML</button>
        <button class="btn" onclick="testGetSelection()">Selection</button>
        <button class="btn" onclick="testEnv()">Env</button>
    </div>
    <div class="btn-group">
        <button class="btn" onclick="testHighlight()">Highlight</button>
        <button class="btn" onclick="testNotify()">Notify</button>
        <button class="btn" onclick="testCapture()">Screenshot</button>
        <button class="btn" onclick="testExtract()">Extract</button>
        <button class="btn" onclick="testContextMenu()">Context Menu</button>
    </div>
    <div class="btn-group">
        <button class="btn" onclick="testInsertWidget()">Insert Widget</button>
        <button class="btn" onclick="testRemoveWidget()">Remove Widget</button>
        <button class="btn" onclick="testInjectCSS()">Inject CSS</button>
        <button class="btn" onclick="testRemoveCSS()">Remove CSS</button>
    </div>
    <div class="btn-group">
        <button class="btn" onclick="testExtractLinks()">Extract Links</button>
        <button class="btn" onclick="testExtractImages()">Extract Images</button>
        <button class="btn" onclick="testQueryElement()">Query Elements</button>
    </div>
    <div class="btn-group">
        <button class="btn" onclick="testStorage()">Storage</button>
        <button class="btn" onclick="testNetworkAllowed()">Network âœ…</button>
        <button class="btn" onclick="testNetworkBlocked()">Network ðŸš«</button>
    </div>

    <div class="result" id="result">Click a button to test SDK API...</div>
    <img id="screenshot" class="screenshot" style="display:none" />

    <!-- GemiGo Extension SDK -->
    <script src="/sdk/gemigo-app-sdk.umd.js"></script>
    <script>
        // No more alias needed! 'gemigo' is now the global variable
        console.log('[Test App] SDK Loaded:', gemigo);

        // Subscribe to context menu events
        gemigo.extension.onContextMenu((event) => {
            console.log('[Test App] Context menu event:', event);
            showResult('Context Menu Event (real-time)', event);
        });

        // Subscribe to selection change events
        gemigo.extension.onSelectionChange((text, rect, url) => {
            console.log('[Test App] Selection changed:', text, rect);
            showResult('Selection Changed (real-time)', {
                text: text.slice(0, 100),
                rect,
                url
            });
        });

        // Check for pending events on load
        gemigo.extension.getContextMenuEvent().then(result => {
            if (result.success && result.event) {
                showResult('Context Menu Event (pending)', result.event);
            }
            document.getElementById('status').textContent = 'âœ… Connected to GemiGo';
            document.getElementById('status').className = 'status connected';
        }).catch(err => {
            console.log('Connection pending or failed', err);
        });

        function showResult(title, data) {
            document.getElementById('result').textContent =
                `[${title}]\n` + JSON.stringify(data, null, 2);
            document.getElementById('screenshot').style.display = 'none';
        }

        async function testGetPageInfo() {
            // Extension API
            const result = await gemigo.extension.getPageInfo();
            showResult('getPageInfo()', result);
        }

        async function testGetPageHTML() {
            const result = await gemigo.extension.getPageHTML();
            showResult('getPageHTML()', { length: result.length, preview: result.slice(0, 500) });
        }

        async function testGetSelection() {
            const result = await gemigo.extension.getSelection();
            showResult('getSelection()', { selection: result });
        }

        async function testEnv() {
            showResult('env', {
                platform: gemigo.platform,
                capabilities: gemigo.capabilities,
            });
        }

        async function testNotify() {
            // Common API - uses options object
            const result = await gemigo.notify({ title: 'GemiGo Notification', body: 'This is a test notification!' });
            showResult('notify()', result);
        }

        async function testCapture() {
            const result = await gemigo.extension.captureVisible();
            if (result.success && result.dataUrl) {
                showResult('captureVisible()', { success: true, size: result.dataUrl.length });
                const img = document.getElementById('screenshot');
                img.src = result.dataUrl;
                img.style.display = 'block';
            } else {
                showResult('captureVisible()', result);
            }
        }

        async function testExtract() {
            const result = await gemigo.extension.extractArticle();
            showResult('extractArticle()', {
                success: result.success,
                title: result.title,
                excerpt: result.excerpt,
                contentLength: result.content?.length
            });
        }

        async function testContextMenu() {
            const result = await gemigo.extension.getContextMenuEvent();
            if (result.success && result.event) {
                showResult('getContextMenuEvent()', result.event);
            } else {
                showResult('getContextMenuEvent()', { status: 'No pending event.' });
            }
        }

        // ========== New P1 API Tests ==========
        let currentWidgetId = null;
        let currentStyleId = null;
        let currentHighlightId = null;

        async function testInsertWidget() {
            const widgetHtml = `
                <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 16px 24px; border-radius: 12px; font-family: sans-serif; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                    <div style="font-weight: 600; margin-bottom: 8px;">ðŸŽ‰ GemiGo Widget</div>
                    <div style="font-size: 0.9em; opacity: 0.9;">This widget was inserted by SDK!</div>
                </div>
            `;
            const result = await gemigo.extension.insertWidget(widgetHtml, 'bottom-right');
            if (result.success) {
                currentWidgetId = result.widgetId;
            }
            showResult('insertWidget()', result);
        }

        async function testRemoveWidget() {
            if (!currentWidgetId) {
                showResult('removeWidget()', { error: 'No widget to remove. Insert one first.' });
                return;
            }
            const result = await gemigo.extension.removeWidget(currentWidgetId);
            currentWidgetId = null;
            showResult('removeWidget()', result);
        }

        async function testInjectCSS() {
            const css = `
                body {
                    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%) !important;
                }
                h1, h2, h3 {
                    color: #e94560 !important;
                    text-shadow: 0 0 20px rgba(233, 69, 96, 0.5);
                }
                p {
                    color: #eee !important;
                }
            `;
            const result = await gemigo.extension.injectCSS(css);
            if (result.success) {
                currentStyleId = result.styleId;
            }
            showResult('injectCSS()', result);
        }

        async function testRemoveCSS() {
            if (!currentStyleId) {
                showResult('removeCSS()', { error: 'No CSS to remove. Inject some first.' });
                return;
            }
            const result = await gemigo.extension.removeCSS(currentStyleId);
            currentStyleId = null;
            showResult('removeCSS()', result);
        }

        async function testHighlight() {
            const result = await gemigo.extension.highlight('h1, h2, h3');
            if (result.success) {
                currentHighlightId = result.highlightId;
            }
            showResult('highlight()', result);
        }

        // ========== P2 API Tests ==========
        async function testExtractLinks() {
            const result = await gemigo.extension.extractLinks();
            showResult('extractLinks()', {
                success: result.success,
                count: result.links?.length || 0,
                sample: result.links?.slice(0, 5)
            });
        }

        async function testExtractImages() {
            const result = await gemigo.extension.extractImages();
            showResult('extractImages()', {
                success: result.success,
                count: result.images?.length || 0,
                sample: result.images?.slice(0, 5)
            });
        }

        async function testQueryElement() {
            const result = await gemigo.extension.queryElement('h1, h2, h3, p', 10);
            showResult('queryElement()', result);
        }

        // ========== Storage / Network ==========
        async function testStorage() {
            const key = 'sdk_test_key';
            const value = { t: Date.now(), rand: Math.random() };
            await gemigo.storage.set(key, value);
            const got = await gemigo.storage.get(key);
            await gemigo.storage.clear();
            showResult('storage.*', { set: value, get: got, cleared: true });
        }

        async function testNetworkAllowed() {
            try {
                const result = await gemigo.network.request('https://api.github.com', { responseType: 'json' });
                showResult('network.request(allowed)', {
                    status: result.status,
                    headers: result.headers,
                    sample: result.data,
                });
            } catch (err) {
                showResult('network.request(allowed)', {
                    error: {
                        name: err?.name,
                        message: err?.message,
                        code: err?.code,
                    }
                });
            }
        }

        async function testNetworkBlocked() {
            try {
                await gemigo.network.request('https://example.com', { responseType: 'text' });
                showResult('network.request(blocked)', { unexpected: true });
            } catch (err) {
                showResult('network.request(blocked)', {
                    expected: true,
                    error: {
                        name: err?.name,
                        message: err?.message,
                        code: err?.code,
                    }
                });
            }
        }
    </script>
</body>

</html>