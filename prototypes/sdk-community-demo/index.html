<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GemiGo Community â€” ç¤¾åŒºå¹¿åœº</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg-base: #0a0f1a;
      --bg-elevated: #111827;
      --bg-card: linear-gradient(145deg, rgba(30, 41, 59, 0.5), rgba(15, 23, 42, 0.8));
      --bg-input: rgba(15, 23, 42, 0.6);
      --border-subtle: rgba(148, 163, 184, 0.12);
      --border-default: rgba(148, 163, 184, 0.2);
      --border-accent: rgba(99, 102, 241, 0.4);
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --accent-primary: #6366f1;
      --accent-secondary: #8b5cf6;
      --accent-success: #10b981;
      --accent-danger: #f43f5e;
      --accent-warning: #f59e0b;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-normal: 200ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background:
        radial-gradient(ellipse 100% 80% at 20% 0%, rgba(99, 102, 241, 0.15), transparent),
        radial-gradient(ellipse 80% 60% at 80% 20%, rgba(139, 92, 246, 0.12), transparent),
        radial-gradient(ellipse 60% 40% at 40% 100%, rgba(16, 185, 129, 0.08), transparent),
        var(--bg-base);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
    }

    /* Layout */
    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Header */
    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .app-header h1 {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .app-header h1::before {
      content: 'âœ¦';
      font-size: 20px;
      -webkit-text-fill-color: var(--accent-primary);
    }

    .app-description {
      color: var(--text-muted);
      font-size: 13px;
      max-width: 600px;
      line-height: 1.5;
    }

    /* Auth Status Bar */
    .auth-bar {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 12px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      margin-bottom: 24px;
      backdrop-filter: blur(12px);
    }

    .auth-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-muted);
      transition: var(--transition-fast);
    }

    .status-indicator.connected {
      background: var(--accent-success);
      box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
    }

    .auth-info {
      display: flex;
      gap: 16px;
      flex: 1;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .auth-info span {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .auth-info code {
      font-family: 'SF Mono', Consolas, monospace;
      font-size: 11px;
      padding: 2px 6px;
      background: rgba(99, 102, 241, 0.1);
      border-radius: 4px;
      color: var(--accent-primary);
    }

    .auth-actions {
      display: flex;
      gap: 8px;
    }

    /* Main Grid */
    .main-grid {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 24px;
    }

    @media (max-width: 900px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Sidebar */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* Cards */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      padding: 20px;
      backdrop-filter: blur(12px);
      transition: var(--transition-normal);
    }

    .card:hover {
      border-color: var(--border-default);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title .icon {
      font-size: 16px;
    }

    .card-badge {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(99, 102, 241, 0.15);
      color: var(--accent-primary);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Forms */
    .form-group {
      margin-bottom: 14px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    label {
      display: block;
      font-size: 11px;
      font-weight: 500;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    input,
    textarea,
    select {
      width: 100%;
      padding: 10px 12px;
      font-size: 13px;
      font-family: inherit;
      color: var(--text-primary);
      background: var(--bg-input);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      transition: var(--transition-fast);
      outline: none;
    }

    input:focus,
    textarea:focus,
    select:focus {
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
    }

    input::placeholder,
    textarea::placeholder {
      color: var(--text-muted);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6,9 12,15 18,9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 14px;
      font-size: 12px;
      font-weight: 600;
      font-family: inherit;
      border-radius: var(--radius-sm);
      border: 1px solid transparent;
      cursor: pointer;
      transition: var(--transition-fast);
      white-space: nowrap;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: white;
      border: none;
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .btn-secondary {
      background: rgba(148, 163, 184, 0.1);
      color: var(--text-secondary);
      border: 1px solid var(--border-subtle);
    }

    .btn-secondary:hover:not(:disabled) {
      background: rgba(148, 163, 184, 0.15);
      color: var(--text-primary);
    }

    .btn-danger {
      background: rgba(244, 63, 94, 0.1);
      color: var(--accent-danger);
      border: 1px solid rgba(244, 63, 94, 0.2);
    }

    .btn-danger:hover:not(:disabled) {
      background: rgba(244, 63, 94, 0.15);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
      padding: 6px 10px;
    }

    .btn-ghost:hover:not(:disabled) {
      background: rgba(148, 163, 184, 0.1);
      color: var(--text-primary);
    }

    .btn-icon {
      padding: 8px;
      min-width: 32px;
    }

    .btn-sm {
      padding: 6px 10px;
      font-size: 11px;
    }

    .btn-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* Feed Area */
    .feed-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .feed-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .feed-tabs {
      display: flex;
      gap: 4px;
      padding: 4px;
      background: rgba(30, 41, 59, 0.5);
      border-radius: var(--radius-md);
    }

    .feed-tab {
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      background: transparent;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .feed-tab:hover {
      color: var(--text-primary);
    }

    .feed-tab.active {
      background: var(--accent-primary);
      color: white;
    }

    .feed-actions {
      display: flex;
      gap: 8px;
    }

    /* Post Cards */
    .post-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .post-card {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      padding: 16px 20px;
      backdrop-filter: blur(12px);
      transition: var(--transition-normal);
    }

    .post-card:hover {
      border-color: var(--border-default);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .post-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .post-meta {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .post-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .post-info {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .post-info code {
      font-family: 'SF Mono', Consolas, monospace;
      font-size: 10px;
      padding: 1px 4px;
      background: rgba(99, 102, 241, 0.1);
      border-radius: 3px;
      color: var(--accent-primary);
    }

    .visibility-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 500;
    }

    .visibility-badge.public {
      background: rgba(16, 185, 129, 0.15);
      color: var(--accent-success);
    }

    .visibility-badge.private {
      background: rgba(245, 158, 11, 0.15);
      color: var(--accent-warning);
    }

    .post-body {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 12px;
      white-space: pre-wrap;
    }

    .post-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-top: 12px;
      border-top: 1px solid var(--border-subtle);
    }

    .post-stats {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .post-actions {
      display: flex;
      gap: 4px;
    }

    .like-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 6px 10px;
      font-size: 12px;
      background: rgba(244, 63, 94, 0.08);
      border: 1px solid rgba(244, 63, 94, 0.15);
      border-radius: var(--radius-sm);
      color: var(--accent-danger);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .like-btn:hover {
      background: rgba(244, 63, 94, 0.15);
      transform: scale(1.02);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
      font-size: 13px;
    }

    .empty-state .icon {
      font-size: 32px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    /* Console/Output */
    .console-card {
      margin-top: 24px;
    }

    .console-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: rgba(15, 23, 42, 0.8);
      border-radius: var(--radius-md) var(--radius-md) 0 0;
      border: 1px solid var(--border-subtle);
      border-bottom: none;
    }

    .console-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .console-content {
      background: rgba(2, 6, 23, 0.9);
      border: 1px solid var(--border-subtle);
      border-top: none;
      border-radius: 0 0 var(--radius-md) var(--radius-md);
      padding: 16px;
      max-height: 300px;
      overflow: auto;
    }

    .console-content pre {
      font-family: 'SF Mono', Consolas, 'Liberation Mono', monospace;
      font-size: 11px;
      color: var(--text-secondary);
      line-height: 1.6;
      margin: 0;
      white-space: pre-wrap;
    }

    .console-content .log-entry {
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .console-content .log-entry:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    .console-content .log-title {
      color: var(--accent-primary);
      font-weight: 600;
      margin-bottom: 4px;
    }

    /* Config Panel */
    .config-toggle {
      font-size: 11px;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .config-toggle:hover {
      color: var(--text-secondary);
    }

    .config-panel {
      display: none;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-subtle);
    }

    .config-panel.show {
      display: block;
    }

    .config-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    @media (max-width: 600px) {
      .config-row {
        grid-template-columns: 1fr;
      }
    }

    /* Toast */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .toast {
      padding: 12px 16px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      font-size: 13px;
      box-shadow: var(--shadow-lg);
      animation: slideIn 0.3s ease;
    }

    .toast.success {
      border-color: var(--accent-success);
    }

    .toast.error {
      border-color: var(--accent-danger);
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Utility */
    .text-muted {
      color: var(--text-muted);
    }

    .text-small {
      font-size: 12px;
    }

    .mt-2 {
      margin-top: 8px;
    }

    .mt-3 {
      margin-top: 12px;
    }

    /* Loading */
    .loading {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--text-muted);
      font-size: 12px;
    }

    .loading::before {
      content: '';
      width: 14px;
      height: 14px;
      border: 2px solid var(--border-default);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <div class="app-container">
    <!-- Header -->
    <header class="app-header">
      <div>
        <h1>GemiGo Community</h1>
        <p class="app-description">
          ä¸€ä¸ªåŸºäº GemiGo App SDK æ„å»ºçš„ç¤¾åŒºåº”ç”¨åŸå‹ï¼ŒéªŒè¯ wx.cloud é£æ ¼çš„æ•°æ®åº“ APIã€æƒé™è§„åˆ™å’Œåˆ†é¡µåŠŸèƒ½ã€‚
        </p>
      </div>
    </header>

    <!-- Auth Bar -->
    <div class="auth-bar">
      <div class="auth-status">
        <span id="authIndicator" class="status-indicator"></span>
        <span id="authText">æœªç™»å½•</span>
      </div>
      <div class="auth-info">
        <span>App ID: <code id="currentAppId">-</code></span>
        <span>User ID: <code id="appUserId">-</code></span>
      </div>
      <div class="auth-actions">
        <button id="loginBtn" class="btn btn-primary btn-sm">ç™»å½•</button>
        <button id="logoutBtn" class="btn btn-secondary btn-sm">é€€å‡º</button>
        <button id="tokenBtn" class="btn btn-ghost btn-sm">ğŸ”‘</button>
      </div>
      <div class="config-toggle" onclick="toggleConfig()">
        âš™ï¸ é…ç½®
      </div>
    </div>

    <!-- Config Panel -->
    <div id="configPanel" class="card config-panel">
      <div class="config-row">
        <div class="form-group">
          <label>API Base URL</label>
          <input id="apiBaseUrl" type="text" />
        </div>
        <div class="form-group">
          <label>Platform Origin</label>
          <input id="platformOrigin" type="text" />
        </div>
        <div class="form-group">
          <label>App ID</label>
          <input id="appId" type="text" />
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-grid">
      <!-- Sidebar -->
      <aside class="sidebar">
        <!-- Create Post Card -->
        <div class="card">
          <div class="card-header">
            <span class="card-title"><span class="icon">âœï¸</span> å‘å¸ƒå¸–å­</span>
          </div>
          <div class="form-group">
            <label>æ ‡é¢˜</label>
            <input id="postTitle" type="text" placeholder="è¾“å…¥å¸–å­æ ‡é¢˜..." />
          </div>
          <div class="form-group">
            <label>å†…å®¹</label>
            <textarea id="postBody" placeholder="åˆ†äº«ä½ çš„æƒ³æ³•..."></textarea>
          </div>
          <div class="form-group">
            <label>å¯è§æ€§</label>
            <select id="postVisibility">
              <option value="public">ğŸŒ å…¬å¼€ - æ‰€æœ‰äººå¯è§</option>
              <option value="private">ğŸ”’ ç§å¯† - ä»…è‡ªå·±å¯è§</option>
            </select>
          </div>
          <div class="btn-row mt-3">
            <button id="createBtn" class="btn btn-primary">å‘å¸ƒ</button>
            <button id="testSystemFieldBtn" class="btn btn-danger btn-sm" title="æµ‹è¯•å†™å…¥ç³»ç»Ÿå­—æ®µï¼ˆåº”å¤±è´¥ï¼‰">
              âš ï¸ æµ‹è¯•
            </button>
          </div>
        </div>

        <!-- Pagination Settings -->
        <div class="card">
          <div class="card-header">
            <span class="card-title"><span class="icon">ğŸ“„</span> åˆ†é¡µè®¾ç½®</span>
          </div>
          <div class="form-group">
            <label>æ¯é¡µæ•°é‡</label>
            <input id="feedLimit" type="number" value="10" min="1" max="50" />
          </div>
          <div class="form-group">
            <label>è·³è¿‡æ•°é‡ (skip)</label>
            <input id="feedSkip" type="number" value="0" min="0" />
          </div>
          <p class="text-muted text-small mt-2">
            ğŸ’¡ æ¨èä½¿ç”¨ cursor åˆ†é¡µè€Œéå¤§ skip å€¼
          </p>
        </div>

        <!-- Negative Tests -->
        <div class="card">
          <div class="card-header">
            <span class="card-title"><span class="icon">ğŸ§ª</span> è´Ÿé¢æµ‹è¯•</span>
            <span class="card-badge">Debug</span>
          </div>
          <p class="text-muted text-small" style="margin-bottom: 12px;">
            æµ‹è¯•è§„åˆ™éªŒè¯æ˜¯å¦æ­£å¸¸å·¥ä½œ
          </p>
          <div class="btn-row">
            <button id="testNoWhereBtn" class="btn btn-danger btn-sm">
              æ—  where æŸ¥è¯¢
            </button>
          </div>
        </div>
      </aside>

      <!-- Feed Area -->
      <main class="feed-container">
        <div class="feed-header">
          <div class="feed-tabs">
            <button id="tabPublic" class="feed-tab active" data-tab="public">
              ğŸŒ å…¬å¼€å¹¿åœº
            </button>
            <button id="tabMine" class="feed-tab" data-tab="mine">
              ğŸ‘¤ æˆ‘çš„å¸–å­
            </button>
            <button id="tabPrivate" class="feed-tab" data-tab="private">
              ğŸ”’ ç§å¯†
            </button>
          </div>
          <div class="feed-actions">
            <button id="refreshBtn" class="btn btn-secondary btn-sm">
              ğŸ”„ åˆ·æ–°
            </button>
            <button id="loadMoreBtn" class="btn btn-ghost btn-sm" disabled>
              åŠ è½½æ›´å¤š
            </button>
          </div>
        </div>

        <div id="feedList" class="post-list">
          <div class="empty-state">
            <div class="icon">ğŸ“­</div>
            <p>æš‚æ— å†…å®¹ï¼Œç™»å½•åæŸ¥çœ‹æˆ–å‘å¸ƒå¸–å­</p>
          </div>
        </div>
      </main>
    </div>

    <!-- Console -->
    <div class="console-card">
      <div class="console-header">
        <span class="console-title">
          <span>ğŸ“Ÿ</span> æ§åˆ¶å°è¾“å‡º
        </span>
        <button id="clearConsoleBtn" class="btn btn-ghost btn-sm">æ¸…ç©º</button>
      </div>
      <div class="console-content">
        <pre id="consoleOutput">(ç­‰å¾…æ“ä½œ...)</pre>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <script src="/packages/app-sdk/dist/gemigo-app-sdk.umd.js"></script>
  <script>
    // ============================================
    // State Management
    // ============================================
    const state = {
      token: null,
      currentTab: 'public',
      feedCursor: null,
    };

    // ============================================
    // DOM Elements
    // ============================================
    const $ = (id) => document.getElementById(id);

    const elements = {
      // Auth
      authIndicator: $('authIndicator'),
      authText: $('authText'),
      currentAppId: $('currentAppId'),
      appUserId: $('appUserId'),
      loginBtn: $('loginBtn'),
      logoutBtn: $('logoutBtn'),
      tokenBtn: $('tokenBtn'),

      // Config
      configPanel: $('configPanel'),
      apiBaseUrl: $('apiBaseUrl'),
      platformOrigin: $('platformOrigin'),
      appId: $('appId'),

      // Post form
      postTitle: $('postTitle'),
      postBody: $('postBody'),
      postVisibility: $('postVisibility'),
      createBtn: $('createBtn'),
      testSystemFieldBtn: $('testSystemFieldBtn'),

      // Feed
      feedList: $('feedList'),
      refreshBtn: $('refreshBtn'),
      loadMoreBtn: $('loadMoreBtn'),
      feedLimit: $('feedLimit'),
      feedSkip: $('feedSkip'),

      // Tabs
      tabPublic: $('tabPublic'),
      tabMine: $('tabMine'),
      tabPrivate: $('tabPrivate'),

      // Tests
      testNoWhereBtn: $('testNoWhereBtn'),

      // Console
      consoleOutput: $('consoleOutput'),
      clearConsoleBtn: $('clearConsoleBtn'),

      // Toast
      toastContainer: $('toastContainer'),
    };

    // ============================================
    // Utilities
    // ============================================
    function log(title, payload) {
      const timestamp = new Date().toLocaleTimeString();
      const content = typeof payload === 'string'
        ? payload
        : JSON.stringify(payload, null, 2);

      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `
          <div class="log-title">[${timestamp}] ${title}</div>
          <div>${content}</div>
        `;

      if (elements.consoleOutput.textContent === '(ç­‰å¾…æ“ä½œ...)') {
        elements.consoleOutput.innerHTML = '';
      }
      elements.consoleOutput.appendChild(entry);
      elements.consoleOutput.parentElement.scrollTop = elements.consoleOutput.parentElement.scrollHeight;
    }

    function toast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      elements.toastContainer.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function getConfig() {
      return {
        apiBaseUrl: elements.apiBaseUrl.value.trim(),
        platformOrigin: elements.platformOrigin.value.trim(),
        appId: elements.appId.value.trim(),
      };
    }

    function requireCloud() {
      if (!window.gemigo?.cloud) {
        throw new Error('gemigo.cloud ä¸å¯ç”¨ï¼Œè¯·ç¡®è®¤ SDK å·²æ­£ç¡®åŠ è½½');
      }
      return window.gemigo.cloud;
    }

    function requireDb() {
      const cloud = requireCloud();
      if (typeof cloud.database !== 'function') {
        throw new Error('gemigo.cloud.database() ä¸å¯ç”¨');
      }
      return cloud.database();
    }

    function toggleConfig() {
      elements.configPanel.classList.toggle('show');
    }

    // ============================================
    // Auth
    // ============================================
    function updateAuthUI() {
      const isAuthed = Boolean(state.token?.accessToken);

      elements.authIndicator.className = `status-indicator ${isAuthed ? 'connected' : ''}`;
      elements.authText.textContent = isAuthed ? 'å·²è¿æ¥' : 'æœªç™»å½•';
      elements.currentAppId.textContent = elements.appId.value || '-';
      elements.appUserId.textContent = state.token?.appUserId || '-';

      elements.loginBtn.disabled = isAuthed;
      elements.logoutBtn.disabled = !isAuthed;
    }

    async function handleLogin() {
      try {
        const config = getConfig();
        const token = await window.gemigo.auth.login({
          platformOrigin: config.platformOrigin,
          apiBaseUrl: config.apiBaseUrl,
          appId: config.appId,
          scopes: ['identity:basic', 'db:rw'],
        });

        state.token = token;
        updateAuthUI();
        log('ç™»å½•æˆåŠŸ', token);
        toast('ç™»å½•æˆåŠŸ', 'success');

        // Load feed after login
        loadFeed();
      } catch (err) {
        log('ç™»å½•å¤±è´¥', err.message || String(err));
        toast('ç™»å½•å¤±è´¥: ' + (err.message || err), 'error');
      }
    }

    function handleLogout() {
      try {
        window.gemigo.auth.logout();
      } catch { }

      state.token = null;
      state.feedCursor = null;
      elements.loadMoreBtn.disabled = true;
      updateAuthUI();
      log('å·²é€€å‡ºç™»å½•', 'ok');
      toast('å·²é€€å‡ºç™»å½•');
      renderEmptyFeed();
    }

    function handleShowToken() {
      log('å½“å‰ Token', state.token || '(æ— )');
    }

    // ============================================
    // Post Creation
    // ============================================
    async function handleCreatePost() {
      try {
        const db = requireDb();
        const result = await db.collection('posts').add({
          data: {
            title: elements.postTitle.value.trim() || 'æ— æ ‡é¢˜',
            body: elements.postBody.value,
            visibility: elements.postVisibility.value,
            refType: 'demo',
            refId: 'sdk-community-demo',
            likeCount: 0,
            createdAt: db.serverDate(),
          },
        });

        log('å¸–å­åˆ›å»ºæˆåŠŸ', result);
        toast('å‘å¸ƒæˆåŠŸï¼', 'success');

        // Clear form
        elements.postTitle.value = '';
        elements.postBody.value = '';

        // Refresh feed
        loadFeed();
      } catch (err) {
        log('åˆ›å»ºå¤±è´¥', err.message || String(err));
        toast('å‘å¸ƒå¤±è´¥: ' + (err.message || err), 'error');
      }
    }

    async function handleTestSystemField() {
      try {
        const db = requireDb();
        await db.collection('posts').add({
          data: {
            title: 'æµ‹è¯•å¸–å­',
            body: 'å°è¯•å†™å…¥ _openid ç³»ç»Ÿå­—æ®µ',
            _openid: 'spoofed-id',
            createdAt: db.serverDate(),
          },
        });
        log('âŒ æ„å¤–æˆåŠŸ', 'ç³»ç»Ÿå­—æ®µå†™å…¥åº”è¯¥è¢«é˜»æ­¢ï¼');
        toast('æ„å¤–ï¼šç³»ç»Ÿå­—æ®µå†™å…¥æˆåŠŸäº†ï¼', 'error');
      } catch (err) {
        log('âœ… é¢„æœŸå¤±è´¥', err.message || String(err));
        toast('ç¬¦åˆé¢„æœŸï¼šç³»ç»Ÿå­—æ®µå†™å…¥è¢«æ‹’ç»', 'success');
      }
    }

    // ============================================
    // Feed Loading
    // ============================================
    function renderEmptyFeed() {
      elements.feedList.innerHTML = `
          <div class="empty-state">
            <div class="icon">ğŸ“­</div>
            <p>æš‚æ— å†…å®¹</p>
          </div>
        `;
    }

    function renderPosts(posts) {
      if (!posts || posts.length === 0) {
        renderEmptyFeed();
        return;
      }

      elements.feedList.innerHTML = posts.map(post => `
          <div class="post-card" data-id="${post._id}">
            <div class="post-header">
              <div class="post-meta">
                <h3 class="post-title">${escapeHtml(post.title || '(æ— æ ‡é¢˜)')}</h3>
                <div class="post-info">
                  <code>${post._id?.slice(0, 8) || '-'}...</code>
                  <span class="visibility-badge ${post.visibility || 'public'}">
                    ${post.visibility === 'private' ? 'ğŸ”’ ç§å¯†' : 'ğŸŒ å…¬å¼€'}
                  </span>
                </div>
              </div>
            </div>
            <div class="post-body">${escapeHtml(post.body || '')}</div>
            <div class="post-footer">
              <div class="post-stats">
                <span class="stat-item">â¤ï¸ ${post.likeCount ?? 0}</span>
                <span class="stat-item">ğŸ• ${formatDate(post.createdAt)}</span>
              </div>
              <div class="post-actions">
                <button class="like-btn" onclick="handleLike('${post._id}')">
                  â¤ï¸ ç‚¹èµ
                </button>
              </div>
            </div>
          </div>
        `).join('');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(date) {
      if (!date) return '-';
      try {
        return new Date(date).toLocaleDateString('zh-CN', {
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
        });
      } catch {
        return String(date);
      }
    }

    async function loadFeed(useMore = false) {
      try {
        const db = requireDb();
        const _ = db.command;
        const limit = Math.max(1, Math.min(50, parseInt(elements.feedLimit.value) || 10));
        const skip = Math.max(0, parseInt(elements.feedSkip.value) || 0);

        let query = db.collection('posts');

        // Build query based on current tab
        switch (state.currentTab) {
          case 'public':
            query = query.where({ visibility: _.eq('public') });
            break;
          case 'mine':
            if (!state.token?.appUserId) {
              toast('è¯·å…ˆç™»å½•', 'error');
              return;
            }
            query = query.where({ _openid: _.eq(state.token.appUserId) });
            break;
          case 'private':
            query = query.where({ visibility: _.eq('private') });
            break;
        }

        query = query.orderBy('createdAt', 'desc').limit(limit);

        if (useMore && state.feedCursor) {
          query = query.startAfter(state.feedCursor);
        } else {
          query = query.skip(skip);
        }

        const result = await query.get();

        log(`åŠ è½½ Feed [${state.currentTab}]`, {
          count: result.data?.length || 0,
          hasMore: Boolean(result._meta?.nextCursor),
        });

        renderPosts(result.data);

        state.feedCursor = result._meta?.nextCursor || null;
        elements.loadMoreBtn.disabled = !state.feedCursor;

      } catch (err) {
        log('åŠ è½½å¤±è´¥', err.message || String(err));
        toast('åŠ è½½å¤±è´¥: ' + (err.message || err), 'error');
      }
    }

    async function handleLike(postId) {
      try {
        const db = requireDb();
        const _ = db.command;
        await db.collection('posts').doc(postId).update({
          data: { likeCount: _.inc(1) },
        });
        log('ç‚¹èµæˆåŠŸ', { _id: postId });
        toast('â¤ï¸ å·²ç‚¹èµ', 'success');
        loadFeed();
      } catch (err) {
        log('ç‚¹èµå¤±è´¥', err.message || String(err));
        toast('ç‚¹èµå¤±è´¥', 'error');
      }
    }

    async function handleTestNoWhere() {
      try {
        const db = requireDb();
        const result = await db.collection('posts')
          .orderBy('createdAt', 'desc')
          .limit(5)
          .get();
        log('âŒ æ—  where æŸ¥è¯¢æˆåŠŸï¼ˆè§„åˆ™æ¨¡å¼ä¸‹åº”å¤±è´¥ï¼‰', result);
        toast('æŸ¥è¯¢æˆåŠŸï¼Œä½†åœ¨è§„åˆ™æ¨¡å¼ä¸‹åº”è¯¥å¤±è´¥', 'error');
      } catch (err) {
        log('âœ… é¢„æœŸå¤±è´¥ï¼ˆè§„åˆ™æ‹’ç»æ—  where æŸ¥è¯¢ï¼‰', err.message || String(err));
        toast('ç¬¦åˆé¢„æœŸï¼šè§„åˆ™æ‹’ç»äº†æ— æ¡ä»¶æŸ¥è¯¢', 'success');
      }
    }

    // ============================================
    // Tab Switching
    // ============================================
    function switchTab(tab) {
      state.currentTab = tab;
      state.feedCursor = null;
      elements.loadMoreBtn.disabled = true;

      // Update tab UI
      [elements.tabPublic, elements.tabMine, elements.tabPrivate].forEach(el => {
        el.classList.remove('active');
      });

      if (tab === 'public') elements.tabPublic.classList.add('active');
      else if (tab === 'mine') elements.tabMine.classList.add('active');
      else if (tab === 'private') elements.tabPrivate.classList.add('active');

      loadFeed();
    }

    // ============================================
    // Event Bindings
    // ============================================
    function bindEvents() {
      // Auth
      elements.loginBtn.addEventListener('click', handleLogin);
      elements.logoutBtn.addEventListener('click', handleLogout);
      elements.tokenBtn.addEventListener('click', handleShowToken);

      // Post
      elements.createBtn.addEventListener('click', handleCreatePost);
      elements.testSystemFieldBtn.addEventListener('click', handleTestSystemField);

      // Feed
      elements.refreshBtn.addEventListener('click', () => {
        state.feedCursor = null;
        loadFeed();
      });
      elements.loadMoreBtn.addEventListener('click', () => loadFeed(true));

      // Tabs
      elements.tabPublic.addEventListener('click', () => switchTab('public'));
      elements.tabMine.addEventListener('click', () => switchTab('mine'));
      elements.tabPrivate.addEventListener('click', () => switchTab('private'));

      // Tests
      elements.testNoWhereBtn.addEventListener('click', handleTestNoWhere);

      // Console
      elements.clearConsoleBtn.addEventListener('click', () => {
        elements.consoleOutput.innerHTML = '<span class="text-muted">(å·²æ¸…ç©º)</span>';
      });
    }

    // ============================================
    // Initialization
    // ============================================
    function init() {
      // Set default config values
      elements.apiBaseUrl.value = 'http://127.0.0.1:8787/api/v1';
      elements.platformOrigin.value = 'http://localhost:5173';
      elements.appId.value = 'demo-app';
      elements.postTitle.value = `Hello ${new Date().toLocaleTimeString()}`;
      elements.postBody.value = 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•å¸–å­ã€‚';

      updateAuthUI();
      bindEvents();

      log('åº”ç”¨åˆå§‹åŒ–å®Œæˆ', {
        sdk: Boolean(window.gemigo),
        cloud: Boolean(window.gemigo?.cloud),
      });
    }

    // Start
    init();
  </script>
</body>

</html>